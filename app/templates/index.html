<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Ordering App</title>
    <style>
        :root {
            --bg-color: #f4f7f6;
            --text-color: #333;
            --header-color: #2c3e50;
            --subheader-color: #34495e;
            --card-bg-color: #fff;
            --form-bg-color: #fdfdfd;
            --border-color: #e0e0e0;
            --list-item-bg-color: #f9f9f9;
        }

        body.dark-mode {
            --bg-color: #2c3e50;
            --text-color: #ecf0f1;
            --header-color: #ecf0f1;
            --subheader-color: #bdc3c7;
            --card-bg-color: #34495e;
            --form-bg-color: #2c3e50;
            --border-color: #555;
            --list-item-bg-color: #446688;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        h1 { color: var(--header-color); text-align: center; margin-bottom: 30px; }
        h2 { color: var(--subheader-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-top: 20px; }
        h3 { color: var(--subheader-color); margin-top: 15px; }
        .container { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px; }
        .col { background-color: var(--card-bg-color); padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); flex: 1; min-width: 300px; }
        form { margin-bottom: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--form-bg-color); }
        input[type="text"], input[type="number"], input[type="date"], select { width: calc(100% - 22px); padding: 10px; margin: 8px 0; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--list-item-bg-color); color: var(--text-color); }
        button { background-color: #4CAF50; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        ul { list-style-type: none; padding: 0; }
        li { background-color: var(--list-item-bg-color); border: 1px solid var(--border-color); margin-bottom: 5px; padding: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        li button { margin-left: 10px; padding: 5px 10px; font-size: 14px; }
        #restaurant-list li { cursor: pointer; }
        #restaurant-list li:hover { background-color: #e9e9e9; }
        .restaurant-order-group { border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 20px; background-color: var(--form-bg-color); }
        .order-item-card { border: 1px solid var(--border-color); border-radius: 5px; padding: 10px; margin-top: 10px; background-color: var(--card-bg-color); }
        .locked-order { opacity: 0.7; pointer-events: none; }
        .dark-mode-toggle { position: absolute; top: 20px; right: 20px; padding: 10px 15px; background-color: #34495e; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .dark-mode-toggle:hover { background-color: #2c3e50; }
    </style>
</head>
<body>
    <h1>Food Ordering App</h1>
    <button id="dark-mode-toggle" class="dark-mode-toggle">Toggle Dark Mode</button>
    <div class="container">
        <div class="col">
            <!-- Restaurants -->
            <h2>Restaurants</h2>
            <form id="add-restaurant-form">
                <input type="text" id="new-restaurant-name" placeholder="New restaurant name" required>
                <button type="submit">Add Restaurant</button>
            </form>
            <ul id="restaurant-list"></ul>

            <!-- Menu -->
            <div id="menu-section">
                <h3 id="menu-title">Select a restaurant to manage its menu</h3>
                <form id="add-menu-item-form">
                    <input type="text" id="new-item-name" placeholder="New item name" required>
                    <input type="number" id="new-item-price" placeholder="Price" step="0.01" required>
                    <button type="submit">Add Menu Item</button>
                </form>
                <ul id="menu-item-list"></ul>
            </div>
        </div>
        <div class="col">
            <!-- Order -->
            <h2>Place an Order</h2>
            <form id="place-order-form">
                <div>
                    <label>Restaurant:</label>
                    <select id="order-restaurant-select" required></select>
                    <button type="button" id="view-order-button" style="margin-left: 10px;" disabled>View/Join Order</button>
                </div>
                <div id="open-order-details" style="display:none;">
                    <p><strong>Current Orderer:</strong> <span id="current-orderer-name"></span>
                        <button type="button" id="edit-orderer-button" style="margin-left: 10px; padding: 5px 10px; font-size: 14px;">Edit</button>
                    </p>
                    <label>Your Name (for item):</label>
                    <input type="text" id="order-user-name" placeholder="Your name for item">
                    <label>Notes (optional):</label>
                    <input type="text" id="order-item-notes" placeholder="Special requests, allergies, etc.">
                    <h3>Menu</h3>
                    <ul id="order-menu-list"></ul>
                    <h3>Items in this Order</h3>
                    <ul id="current-order-items-list"></ul>
                    <button type="button" id="lock-order-button" style="background-color: #e74c3c;">Lock Order</button>
                </div>
                <button type="submit" style="display:none;">Place Order</button> <!-- This button is now for adding items to open order -->
            </form>
        </div>
        <div class="col">
            <!-- Order History -->
            <h2>Order History</h2>
            <form id="filter-history-form">
                <label for="history-date-filter">Filter by date:</label>
                <input type="date" id="history-date-filter">
                <button type="button" id="filter-history-button">Filter</button>
                <button type="button" id="clear-filter-history-button">Clear</button>
            </form>
            <div id="order-history"></div>
        </div>
    </div>

    <script>
        const apiUrl = '/api';

        const restaurantList = document.getElementById('restaurant-list');
        const addRestaurantForm = document.getElementById('add-restaurant-form');
        const newRestaurantNameInput = document.getElementById('new-restaurant-name');

        const menuSection = document.getElementById('menu-section');
        const menuTitle = document.getElementById('menu-title');
        const menuItemList = document.getElementById('menu-item-list');
        const addMenuItemForm = document.getElementById('add-menu-item-form');
        const newItemNameInput = document.getElementById('new-item-name');
        const newItemPriceInput = document.getElementById('new-item-price');

        const orderRestaurantSelect = document.getElementById('order-restaurant-select');
        const viewOrderButton = document.getElementById('view-order-button');
        const openOrderDetails = document.getElementById('open-order-details');
        const currentOrdererNameSpan = document.getElementById('current-orderer-name');
        const editOrdererButton = document.getElementById('edit-orderer-button');
        const orderUserNameInput = document.getElementById('order-user-name');
        const orderItemNotesInput = document.getElementById('order-item-notes');
        const orderMenuList = document.getElementById('order-menu-list');
        const currentOrderItemsList = document.getElementById('current-order-items-list');
        const lockOrderButton = document.getElementById('lock-order-button');
        const placeOrderForm = document.getElementById('place-order-form');

        const orderHistory = document.getElementById('order-history');
        const historyDateFilter = document.getElementById('history-date-filter');
        const filterHistoryButton = document.getElementById('filter-history-button');
        const clearFilterHistoryButton = document.getElementById('clear-filter-history-button');
        const darkModeToggle = document.getElementById('dark-mode-toggle'); // Added for dark mode

        let selectedRestaurantId = null;
        let currentOpenOrder = null;
        let allOrders = []; // Cache for all orders

        // Load and save user name for ordering
        const savedUserName = localStorage.getItem('orderUserName');
        if (savedUserName) {
            orderUserNameInput.value = savedUserName;
        }
        orderUserNameInput.addEventListener('input', () => {
            localStorage.setItem('orderUserName', orderUserNameInput.value);
        });

        // Dark Mode Logic
        const enableDarkMode = () => {
            document.body.classList.add('dark-mode');
            localStorage.setItem('dark-mode', 'enabled');
        };

        const disableDarkMode = () => {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('dark-mode', 'disabled');
        };

        // Check for saved dark mode preference on load
        if (localStorage.getItem('dark-mode') === 'enabled') {
            enableDarkMode();
        }

        // Toggle dark mode on button click
        darkModeToggle.addEventListener('click', () => {
            if (document.body.classList.contains('dark-mode')) {
                disableDarkMode();
            } else {
                enableDarkMode();
            }
        });

        // Fetch and display restaurants
        const fetchRestaurants = async () => {
            console.log('Fetching restaurants...');
            const response = await fetch(`${apiUrl}/restaurants`);
            const restaurants = await response.json();
            console.log('Fetched restaurants:', restaurants);
            restaurantList.innerHTML = '';
            orderRestaurantSelect.innerHTML = '<option value="">Select a restaurant</option>';
            restaurants.forEach(r => {
                const li = document.createElement('li');
                li.textContent = r.name;
                li.style.cursor = 'pointer';
                li.onclick = () => selectRestaurant(r);

                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                editButton.onclick = (e) => { e.stopPropagation(); editRestaurant(r.id, r.name); };
                li.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.style.backgroundColor = '#e74c3c';
                deleteButton.onclick = (e) => { e.stopPropagation(); deleteRestaurant(r.id); };
                li.appendChild(deleteButton);

                restaurantList.appendChild(li);

                const option = document.createElement('option');
                option.value = r.id;
                option.textContent = r.name;
                orderRestaurantSelect.appendChild(option);
            });
        };

        // Edit a restaurant
        const editRestaurant = async (id, currentName) => {
            const newName = prompt('Enter new name for restaurant:', currentName);
            if (newName && newName.trim() !== '') {
                await fetch(`${apiUrl}/restaurants/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName }),
                });
                fetchRestaurants();
            }
        };

        // Delete a restaurant
        const deleteRestaurant = async (id) => {
            if (confirm('Are you sure you want to delete this restaurant and all its associated menus and orders?')) {
                await fetch(`${apiUrl}/restaurants/${id}`, { method: 'DELETE' });
                fetchRestaurants();
                fetchOrderHistory();
                if (selectedRestaurantId === id) {
                    selectedRestaurantId = null;
                    menuTitle.textContent = 'Select a restaurant to manage its menu';
                    menuItemList.innerHTML = '';
                    addMenuItemForm.querySelector('button[type="submit"]').disabled = true;
                    newItemNameInput.disabled = true;
                    newItemPriceInput.disabled = true;
                    openOrderDetails.style.display = 'none';
                    currentOpenOrder = null;
                }
            }
        };

        // Select a restaurant to view/edit its menu
        const selectRestaurant = async (restaurant) => {
            selectedRestaurantId = restaurant.id;
            menuTitle.textContent = `${restaurant.name} Menu`;
            addMenuItemForm.querySelector('button[type="submit"]').disabled = false;
            newItemNameInput.disabled = false;
            newItemPriceInput.disabled = false;

            const response = await fetch(`${apiUrl}/restaurants/${restaurant.id}/menu`);
            const menuItems = await response.json();
            menuItemList.innerHTML = '';
            menuItems.forEach(item => {
                const li = document.createElement('li');
                li.textContent = `${item.name} - ${item.price}.ден`;
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.onclick = () => deleteMenuItem(item.id);
                li.appendChild(deleteButton);
                menuItemList.appendChild(li);
            });
        };

        // Add a new restaurant
        addRestaurantForm.onsubmit = async (e) => {
            e.preventDefault();
            console.log('Adding restaurant:', newRestaurantNameInput.value);
            const response = await fetch(`${apiUrl}/restaurants`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newRestaurantNameInput.value }),
            });
            const data = await response.json();
            console.log('Add restaurant response:', data);
            newRestaurantNameInput.value = '';
            fetchRestaurants();
        };

        // Add a new menu item
        addMenuItemForm.onsubmit = async (e) => {
            e.preventDefault();
            if (!selectedRestaurantId) {
                alert('Please select a restaurant first.');
                return;
            }
            await fetch(`${apiUrl}/restaurants/${selectedRestaurantId}/menu`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newItemNameInput.value, price: newItemPriceInput.value }),
            });
            newItemNameInput.value = '';
            newItemPriceInput.value = '';
            selectRestaurant({ id: selectedRestaurantId, name: menuTitle.textContent.replace(' Menu', '') });
        };

        // Delete a menu item
        const deleteMenuItem = async (id) => {
            if (confirm('Are you sure you want to delete this menu item?')) {
                await fetch(`${apiUrl}/menu/${id}`, { method: 'DELETE' });
                selectRestaurant({ id: selectedRestaurantId, name: menuTitle.textContent.replace(' Menu', '') });
            }
        };

        // Handle restaurant selection for ordering
        orderRestaurantSelect.onchange = () => {
            const restaurantId = orderRestaurantSelect.value;
            openOrderDetails.style.display = 'none'; // Always hide on change
            currentOpenOrder = null;
            if (restaurantId) {
                viewOrderButton.disabled = false;
            } else {
                viewOrderButton.disabled = true;
            }
        };

        viewOrderButton.onclick = async () => {
            if (orderUserNameInput.value.trim() === '') {
                alert('Please enter your name before viewing an order.');
                orderUserNameInput.focus();
                return;
            }

            const restaurantId = orderRestaurantSelect.value;
            if (restaurantId) {
                openOrderDetails.style.display = 'block';
                await fetchOpenOrder(restaurantId);
                const response = await fetch(`${apiUrl}/restaurants/${restaurantId}/menu`);
                const menuItems = await response.json();
                orderMenuList.innerHTML = '';
                menuItems.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.name} - ${item.price}.ден`;
                    const addButton = document.createElement('button');
                    addButton.textContent = 'Add to Order';
                    addButton.type = 'button';
                    addButton.onclick = () => addItemToOpenOrder(item);
                    li.appendChild(addButton);
                    orderMenuList.appendChild(li);
                });
            }
        };

        // Fetch or create an open order for the selected restaurant
        const fetchOpenOrder = async (restaurantId) => {
            const response = await fetch(`${apiUrl}/restaurants/${restaurantId}/open-order`);
            currentOpenOrder = await response.json();
            currentOrdererNameSpan.textContent = currentOpenOrder.orderer_name;
            renderCurrentOrderItems();
            updateOrderLockState();
        };

        // Edit the orderer's name
        editOrdererButton.onclick = async () => {
            if (!currentOpenOrder || currentOpenOrder.status === 'locked') {
                alert('Order is locked or not available for editing.');
                return;
            }
            const newOrdererName = prompt("Enter the new orderer's name:", currentOpenOrder.orderer_name);
            if (newOrdererName && newOrdererName.trim() !== '') {
                await fetch(`${apiUrl}/orders/${currentOpenOrder.id}/orderer`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderer_name: newOrdererName }),
                });
                fetchOpenOrder(currentOpenOrder.restaurant_id);
            }
        };

        // Add an item to the current open order
        const addItemToOpenOrder = async (item) => {
            if (!currentOpenOrder || currentOpenOrder.status === 'locked') {
                alert('Order is locked or not available.');
                return;
            }
            if (orderUserNameInput.value.trim() === '') {
                alert('Please enter your name for the item');
                return;
            }

            await fetch(`${apiUrl}/orders/${currentOpenOrder.id}/items`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    user_name: orderUserNameInput.value, 
                    item_name: item.name, 
                    notes: orderItemNotesInput.value,
                    price: item.price
                }),
            });
            orderItemNotesInput.value = ''; // Clear notes after adding
            fetchOpenOrder(currentOpenOrder.restaurant_id);
        };

        // Render items in the current open order
        const renderCurrentOrderItems = () => {
            currentOrderItemsList.innerHTML = '';
            if (currentOpenOrder && currentOpenOrder.items) {
                const itemsByUser = {};
                currentOpenOrder.items.forEach(item => {
                    if (!itemsByUser[item.user_name]) {
                        itemsByUser[item.user_name] = [];
                    }
                    itemsByUser[item.user_name].push(item);
                });

                for (const userName in itemsByUser) {
                    const userLi = document.createElement('li');
                    userLi.style.display = 'block'; // To allow nesting
                    userLi.style.background = 'transparent';
                    userLi.style.border = 'none';
                    userLi.style.padding = '5px 0';

                    let userTotal = 0;
                    const userItemsUl = document.createElement('ul');
                    userItemsUl.style.paddingLeft = '10px';
                    userItemsUl.style.marginTop = '5px';

                    itemsByUser[userName].forEach(item => {
                        userTotal += parseFloat(item.price);
                        const itemLi = document.createElement('li'); // This will have the default li styling
                        
                        let itemText = `${item.item_name} - ${item.price}.ден`;
                        if (item.notes) {
                            itemText += ` (${item.notes})`;
                        }
                        const textSpan = document.createElement('span');
                        textSpan.textContent = itemText;
                        
                        const controlsDiv = document.createElement('div');

                        if (currentOpenOrder.status === 'open') {
                            const editButton = document.createElement('button');
                            editButton.textContent = 'Edit';
                            editButton.onclick = () => editOrderItem(item);
                            controlsDiv.appendChild(editButton);

                            const deleteButton = document.createElement('button');
                            deleteButton.textContent = 'Delete';
                            deleteButton.onclick = () => deleteOrderItem(item.id);
                            controlsDiv.appendChild(deleteButton);
                        }
                        
                        itemLi.appendChild(textSpan);
                        itemLi.appendChild(controlsDiv);
                        userItemsUl.appendChild(itemLi);
                    });

                    const userHeader = document.createElement('strong');
                    userHeader.textContent = `${userName} - Total: ${userTotal.toFixed(2)}.ден`;
                    userLi.appendChild(userHeader);
                    userLi.appendChild(userItemsUl);
                    currentOrderItemsList.appendChild(userLi);
                }
            }
        };

        // Edit an item in the current open order
        const editOrderItem = async (item) => {
            const newUserName = prompt("Enter new name for item:", item.user_name);
            const newItemName = prompt("Enter new item name:", item.item_name);
            const newNotes = prompt("Enter new notes:", item.notes || '');
            const newPrice = prompt("Enter new price:", item.price);

            if (newUserName !== null && newItemName !== null) {
                await fetch(`${apiUrl}/order-items/${item.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_name: newUserName, 
                        item_name: newItemName, 
                        notes: newNotes,
                        price: newPrice
                    }),
                });
                fetchOpenOrder(currentOpenOrder.restaurant_id);
            }
        };

        // Delete an item from the current open order
        const deleteOrderItem = async (itemId) => {
            if (confirm('Are you sure you want to delete this item?')) {
                await fetch(`${apiUrl}/order-items/${itemId}`, { method: 'DELETE' });
                fetchOpenOrder(currentOpenOrder.restaurant_id);
            }
        };

        // Lock the current open order
        lockOrderButton.onclick = async () => {
            if (currentOpenOrder && confirm('Are you sure you want to lock this order? No more changes can be made.')) {
                await fetch(`${apiUrl}/orders/${currentOpenOrder.id}/lock`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });
                fetchOpenOrder(currentOpenOrder.restaurant_id);
                fetchOrderHistory();
            }
        };

        // Update UI based on order lock state
        const updateOrderLockState = () => {
            const isLocked = currentOpenOrder && currentOpenOrder.status === 'locked';
            lockOrderButton.disabled = isLocked;
            editOrdererButton.disabled = isLocked;
            orderUserNameInput.disabled = isLocked;
            orderItemNotesInput.disabled = isLocked;
            orderMenuList.querySelectorAll('button').forEach(button => button.disabled = isLocked);
            if (isLocked) {
                openOrderDetails.classList.add('locked-order');
            } else {
                openOrderDetails.classList.remove('locked-order');
            }
        };

        // Fetch and display order history
        const fetchOrderHistory = async () => {
            const response = await fetch(`${apiUrl}/orders`);
            allOrders = await response.json();
            renderOrderHistory();
        };

        const renderOrderHistory = (filterDate = null) => {
            orderHistory.innerHTML = '';

            let ordersToRender = allOrders;
            if (filterDate) {
                ordersToRender = allOrders.filter(order => {
                    const orderDate = new Date(order.created_at).toISOString().split('T')[0];
                    return orderDate === filterDate;
                });
            }

            const groupedOrders = {};
            ordersToRender.forEach(order => {
                if (!groupedOrders[order.restaurant_name]) {
                    groupedOrders[order.restaurant_name] = [];
                }
                groupedOrders[order.restaurant_name].push(order);
            });

            for (const restaurantName in groupedOrders) {
                const restaurantDiv = document.createElement('div');
                restaurantDiv.className = 'restaurant-order-group';
                restaurantDiv.innerHTML = `<h2>${restaurantName} Orders</h2>`;

                groupedOrders[restaurantName].forEach(order => {
                    const orderDiv = document.createElement('div');
                    orderDiv.className = 'order-item-card';
                    if (order.status === 'locked') {
                        orderDiv.classList.add('locked-order');
                    }

                    const itemsByUser = {};
                    order.items.forEach(item => {
                        if (!itemsByUser[item.user_name]) {
                            itemsByUser[item.user_name] = [];
                        }
                        itemsByUser[item.user_name].push(item);
                    });

                    let itemsHtml = '<ul>';
                    for (const userName in itemsByUser) {
                        let userTotal = 0;
                        itemsHtml += '<li style="display: block; border: none; background: transparent; padding: 5px 0;">';
                        
                        const userItemsUl = document.createElement('ul');
                        userItemsUl.style.paddingLeft = '10px';
                        userItemsUl.style.marginTop = '5px';

                        let userItemsHtml = '';
                        itemsByUser[userName].forEach(item => {
                            userTotal += parseFloat(item.price);
                            userItemsHtml += `<li>${item.item_name} - ${item.price}.ден${item.notes ? ` (${item.notes})` : ''}</li>`;
                        });

                        itemsHtml += `<strong>${userName} - Total: ${userTotal.toFixed(2)}.ден</strong>`;
                        itemsHtml += userItemsHtml;
                        itemsHtml += '</ul></li>';
                    }
                    itemsHtml += '</ul>';

                    orderDiv.innerHTML = `
                        <p><strong>Orderer:</strong> ${order.orderer_name}</p>
                        <p><strong>Status:</strong> ${order.status}</p>
                        <p><strong>Date:</strong> ${new Date(order.created_at).toLocaleString()}</p>
                        ${itemsHtml}
                    `;
                    restaurantDiv.appendChild(orderDiv);
                });
                orderHistory.appendChild(restaurantDiv);
            }
        };

        filterHistoryButton.onclick = () => {
            const filterDate = historyDateFilter.value;
            renderOrderHistory(filterDate);
        };

        clearFilterHistoryButton.onclick = () => {
            historyDateFilter.value = '';
            renderOrderHistory();
        };

        // Initial data load
        fetchRestaurants();
        fetchOrderHistory();

        // Initial state for menu section
        menuTitle.textContent = 'Select a restaurant to manage its menu';
        addMenuItemForm.querySelector('button[type="submit"]').disabled = true;
        newItemNameInput.disabled = true;
        newItemPriceInput.disabled = true;
    </script>
</body>
</html>
